import {WormAdapter} from '/malwares/worm-adapters';
import {WORM_CONFIG} from '/malwares/worm-config';


//FIXME - Something wrong with the sleep duration times...

export async function main(ns) {
    const nsA: WormAdapter = new WormAdapter(ns);
    const hostConst = JSON.parse(ns.read(WORM_CONFIG.INSTALL_PACKAGE[2]));

    //noinspection InfiniteLoopJS
    while (true) {
        const hostState = {
            minSec: hostConst.minSec,
            actualSec: nsA.getServerSecurityLevel(hostConst.hostname),
            maxMoney: hostConst.maxMoney,
            availMoney: nsA.getServerMoneyAvailable(hostConst.hostname),
        };
        
        if (hostState.actualSec > hostState.minSec) {
            const threadQty = Math.floor(hostConst.freeRam / hostConst.weakenRam);
            nsA.exec(WORM_CONFIG.RUN_PACKAGE[1], hostConst.hostname, threadQty);
            await nsA.sleep(hostConst.weakenDuration);
            
        } else if (hostState.availMoney < hostState.maxMoney) {
            const threadQty = Math.floor(hostConst.freeRam / hostConst.growRam);
            nsA.exec(WORM_CONFIG.RUN_PACKAGE[2], hostConst.hostname, threadQty);
            await nsA.sleep(hostConst.growDuration);
            
        } else {
            const threadQty = Math.floor(hostConst.freeRam / hostConst.hackRam);
            nsA.exec(WORM_CONFIG.RUN_PACKAGE[0], hostConst.hostname, threadQty);
            await nsA.sleep(hostConst.hackDuration);
        }
    }
}