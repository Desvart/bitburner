import {Server} from '/resources/network';
import {INs, Log} from '/resources/helpers';
import {getService} from '/resources/service';

export async function main(ns: INs) {
    const log = new Log(ns);
    const malware = 'HACK';
    // noinspection DuplicatedCode
    let timestampStart: number = Date.now();
    
    const target: string = ns.args[0];
    const threadCount: number = ns.args[1];
    let delay: number = ns.args[2]; //ms
    delay ??= 0;
    const blockId: number = ns.args[3];
    const stepId: number = ns.args[4];
    const marketImpact: boolean = ns.args[5];
    let caller: string = ns.args[6];
    if (typeof caller !== undefined)
        caller = caller + ' > ';
    else
        caller ??= '';
    
    let operationId: string = '';
    if (blockId !== 0)
        operationId = `- ${blockId}-${stepId} `;
    
    log.info(`${caller}${malware} ${target} (${threadCount}x) ${operationId}- START in ${log.formatDuration(
        delay)}`);
    await ns.sleep(delay);
    
    timestampStart = Date.now();
    
    log.info(`${caller}${malware} ${target} (${threadCount}x) ${operationId}- START now`);
    const earnedMoney: string = log.formatMoney(await hack(ns, target, threadCount, marketImpact));
    
    const timestampStop: number = Date.now();
    const hackDuration: string = log.formatDuration(timestampStop - timestampStart);
    log.success(
        `${caller}${malware} ${target} (${threadCount}x) ${operationId}- STOP: ${hackDuration} duration; Gain: +${earnedMoney}`);
    
    const node: Server = await getService(ns, 10).then(network => network.getNode(target));
    const msg = `Money ${log.formatMoney(node.getAvailableMoney())} / ${log.formatMoney(node.maxMoney)}, SEC ${node.getSecurityLevel()} / ${node.minSec}`;
    log.info(`STATUS ${target}: ${msg}`);
}

async function hack(ns: INs, target: string, threads: number = 1, stock: boolean = false): Promise<number> {
    return await ns.hack(target, {threads: threads, stock: stock});
}